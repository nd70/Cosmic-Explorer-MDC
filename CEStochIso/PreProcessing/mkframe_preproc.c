#include "mex.h"#include "FrameL.h"void mexFunction( int nlhs, mxArray *plhs[], int nrhs, const mxArray *prhs[]){  struct FrameH *frame;  struct FrProcData *proc, *ptrPossProc;  struct FrFile *oFile, *iFile;  struct FrVect *b, *paramV;  struct FrStatData *StatData, *StatParams;  mxArray *channelName, *ptrType, *dataVector, *ptrMode, *pChannelName;  mxArray *Parameters, *paramCell;  char *mode, *fileName, *name, *type, *comment, *pComment;  char *pChannelStr, *paramStr[200], *cetStr;  double rate, *frameLength, *RealdataPtr, *ImagdataPtr, *Cdataptr;  double paramColsD;   void *dataPtr;   int numData, i, numFields, numElems, elem, elemSize, paramCols, paramElems;  int numParams, nDimParams;   size_t dataBytes;  int lenFile = 255;  int lenChan = 40;  int lenBuf = 8;  int commentBuf = 10000;  double *frameGPS;  time_t utc;  unsigned int t0;  const char *channelField = "channel";  const char *dataField = "data";  const char *typeField = "type";  const char *modeField = "mode";  const char *errBadInput = "mkframe:badParam";  const char *errFrameFail = "mkframe:frameFail";  const char *errBadField = "mkframe:badField";  const char *errBadData = "mkframe:badData";  const double DEFAULT_FRAME_LENGTH = 16;  int compress = 6;    /*  -----check input arguments for correct type----------- */  if(!mxIsChar(prhs[0]) || !mxIsChar(prhs[2]))    {      mexErrMsgIdAndTxt(errBadInput,"%sInput must include: file name(string), write mode(char)",errBadInput);    }    /* -----check is there is anything to be written	*/  if ( nrhs > 5 )    {      if( mxIsEmpty(prhs[1]) && mxIsEmpty(prhs[5]) )	{ 	  mexErrMsgTxt("Neither data nor parameters will be written to frame. Why write it? \n");	}    }	    fileName = mxCalloc(lenFile, sizeof(char));  mxGetString(prhs[0], fileName, lenFile);  mode = mxCalloc(lenBuf, sizeof(char));  mxGetString(prhs[2], mode, lenBuf);  if((mode[0] != 'n') && mode[0] != 'a')    {      mexErrMsgIdAndTxt(errBadInput,"%s The mode for writing must be 'n' or 'a'",errBadInput);    }    if( nrhs > 3 )    {      if( mxIsEmpty(prhs[3]))	{	  frameLength = mxCalloc(1, sizeof(double));	  *frameLength = DEFAULT_FRAME_LENGTH;	  mexPrintf("Input Comment: No frame length provided, setting it to default %f sec\n", DEFAULT_FRAME_LENGTH);	}      else	{	  if(!mxIsNumeric(prhs[3]))	    {	      mexErrMsgIdAndTxt(errBadInput,"%s The frame length must be numeric",errBadInput);	    }	  else	    {	      frameLength = mxGetPr(prhs[3]);	      if(*frameLength <= 0)		{		  mexErrMsgIdAndTxt(errBadInput,"%s The frame length must be > 0",errBadInput);		}    	    }	}    }  else    {      frameLength = mxCalloc(1, sizeof(double));      *frameLength = DEFAULT_FRAME_LENGTH;      mexPrintf("Input Comment: No frame length provided, setting it to default %f sec\n", DEFAULT_FRAME_LENGTH);    }    if( nrhs > 4)    {      if( mxIsEmpty(prhs[4]) )	{ 	  utc = time(NULL);	  frameGPS = mxCalloc(1, sizeof(double));	  *frameGPS = utc - FRGPSOFF + FRGPSLEAPS;	  mexPrintf("Input Comment: No frame GPS provided, setting it to current time \n");	}      else	{	  if(!mxIsNumeric(prhs[4]))	    {	      mexErrMsgIdAndTxt(errBadInput,"%s The frame GPS must be numeric",errBadInput);	    }	  else	    {	      frameGPS = mxGetPr(prhs[4]);	    }	}    }	  else    {      utc = time(NULL);      frameGPS = mxCalloc(1, sizeof(double));      *frameGPS = utc - FRGPSOFF + FRGPSLEAPS;      mexPrintf("Input Comment: No frame GPS provided, setting it to current time \n");    }	    /*---------create frame if the file is new-------*/  if(mode[0] == 'n')    {      frame = FrameNew("LIGO");      if (frame == NULL)        {	  mexErrMsgIdAndTxt(errFrameFail,"%s Error during frame creation\n"			    "Last errors are: \n%s", errFrameFail,FrErrorGetHistory() );        }            FrHistoryAdd(frame, "Created by mkframe");            /*----------add time to frame---------*/      frame->dt = *frameLength;      frame->ULeapS    = FRGPSLEAPS;      frame->GTimeS    = *frameGPS;      t0 = frame->GTimeS;      frame->run = -1;      mexPrintf("MKFRAME: Create new frame file\n");    }  /*------open existing frame file if appending data--------*/  if(mode[0] == 'a')    {      iFile = FrFileINew(fileName);      if(iFile == NULL)        {	  mexErrMsgIdAndTxt(errFrameFail,"%s Cannot open existing frame file",			    errFrameFail);        }      iFile->compress = 6;      frame = FrameRead(iFile);      if(frame == NULL)        {	  mexErrMsgIdAndTxt(errFrameFail,"%s Cannot read existing frame file",			    errFrameFail);        }      FrFileIEnd(iFile);    }    if(mxIsEmpty(prhs[1]))    {       mexPrintf("Input Comment: No data will be written to frame, only parameters will be\n");    }  else if(!mxIsStruct(prhs[1]))    {      mexErrMsgIdAndTxt(errBadInput,"%s The second input must be a structure",errBadInput);    }  else    {      numElems = mxGetNumberOfElements(prhs[1]);      if(numElems < 1)	{	  mexErrMsgIdAndTxt(errBadField,"%s no elements in data structure array",errBadField);	}      for(elem=0; elem < numElems; elem++)	{	  channelName = mxGetField(prhs[1], elem, channelField);	  if(channelName == NULL)	    {	      mexErrMsgIdAndTxt(errBadField,"%s entry %d field %s missing",				errBadField,(elem+1),channelField);	    }	  else	    {	      if(!mxIsChar(channelName))		{		  mexErrMsgIdAndTxt(errBadField,"%s entry %d channel must be string",				    errBadField,elem+1);		}	      name = mxCalloc(lenChan, sizeof(char));	      mxGetString(channelName, name, lenChan);	    }	  if(mode[0] == 'a')	    {	      mexPrintf("MKFRAME: Append Channel %s to existing frame\n",name);	    }	  else	    {	      mexPrintf("MKFRAME: Add Channel %s to new frame\n",name);	    }	  dataVector = mxGetField(prhs[1], elem, dataField);	  if(dataVector == NULL)	    {	      mexErrMsgIdAndTxt(errBadField,"%s entry %d field %s missing",				errBadField,(elem+1),dataField);	    }	  else	    {	      if(!mxIsNumeric(dataVector))		{		  mexErrMsgIdAndTxt(errBadField,"%s entry %d data must be numeric",				    errBadField,elem+1);		}	      dataPtr = mxGetPr(dataVector);	      	      numData = mxGetNumberOfElements(dataVector);		      elemSize = mxGetElementSize(dataVector);	      dataBytes = numData * elemSize;	      rate = numData/(*frameLength);	    }	  	  ptrType = mxGetField(prhs[1], elem, typeField);	  if(ptrType == NULL)	    {	      mexErrMsgIdAndTxt(errBadField,"%s entry %d field %s missing",				errBadField,(elem+1),typeField);	    }	  else	    {	      type = mxCalloc(lenBuf, sizeof(char));	      mxGetString(ptrType, type, lenBuf);	      if((type[0] != 'd') && (type[0] != 'f') && (type[0] != 's') &&		 (type[0] != 'l') && (type[0] != 'i') && (type[0] != 'u')) 		{		  mexErrMsgIdAndTxt(errBadField,				    "%s entry %d type must be one of d,f,s,us,i,ui,l,ul,dc", 				    errBadField,elem+1);		}	      if(type[0] == 'u')		{		  if((type[1] != 's') && (type[1] != 'l') && (type[1] != 'i'))		    {		      mexErrMsgIdAndTxt(errBadField,					"%s entry %d type must be one of d,f,s,us,i,ui,l,ul,dc",					errBadField,elem+1);		    }		}	    }	  ptrMode = mxGetField(prhs[1], elem, modeField);	  if(ptrMode == NULL)	    {	      mexErrMsgIdAndTxt(errBadField,"%s entry %d field %s missing",				errBadField,(elem+1),modeField);	    }	  /* cet: begin converting to proc here */	  ptrPossProc = FrProcDataFind(frame,name);	  if(ptrPossProc != NULL)	    {	      mexErrMsgIdAndTxt(errBadField,				"%s PROC for %s already exists!",				errFrameFail,name);	    }	  if(type[0] == 'd')	    {	      if(!mxIsDouble(dataVector))		{		  mexErrMsgIdAndTxt(errBadData,				    "%s Proc data for %s must be MATLAB double\n Last errors are are:\n%s",				    errBadData,name,FrErrorGetHistory() ); 		}	      	      if(type[1] == 'c')		{ 		  if(!mxIsComplex(dataVector)) 		    {		      mexErrMsgIdAndTxt(errBadData,					"%s Proc data for %s must be MATLAB complex\n Last errors are are:\n%s",					errBadData,name,FrErrorGetHistory() ); 		    }		  		  proc = FrProcDataNew(frame, name, rate, 2*numData, -64);		  if(proc == NULL)		    {		      mexErrMsgIdAndTxt(errFrameFail,					"%s proc for %s is null\n Last errors are:\n%s",					errFrameFail,name,FrErrorGetHistory() );		    }		  		  proc->data->type = FR_VECT_16C;		  proc->data->nData = numData; 		  		  RealdataPtr = mxGetPr(dataVector);		  ImagdataPtr = mxGetPi(dataVector);		  Cdataptr = mxCalloc(2*numData,sizeof(double));				  		  for(i=0; i < numData; i++)  		    {		      Cdataptr[(2*i)] = RealdataPtr[i];  		      Cdataptr[(2*i)+1] = ImagdataPtr[i];		    }		  memcpy(proc->data->data,Cdataptr,2*dataBytes);		}	      else		{		  proc = FrProcDataNew(frame, name, rate, numData, -64);		  if(proc == NULL)		    {		      mexErrMsgIdAndTxt(errFrameFail,					"%s Proc for %s is null\n Last errors are:\n%s",					errFrameFail,name,FrErrorGetHistory() );		    }		  memcpy(proc->data->dataD,dataPtr,dataBytes);		}	      	      	    }	  else if(type[0] == 'f')	    {	      if(!mxIsSingle(dataVector))		{		  mexErrMsgIdAndTxt(errBadData,				    "%s Proc data for %s must be MATLAB single\n Last errors are are:\n%s",				    errBadData,name,FrErrorGetHistory() ); 		}	      proc = FrProcDataNew(frame, name, rate, numData, -32);	      if(proc == NULL)		{		  mexErrMsgIdAndTxt(errFrameFail,				    "%s Proc for %s is null\n Last errors are:\n%s",				    errFrameFail,name,FrErrorGetHistory() );		}	      memcpy(proc->data->dataF,dataPtr,dataBytes);	    }	  else if(type[0] == 's')	    {	      if(!mxIsInt16(dataVector))		{		  mexErrMsgIdAndTxt(errBadData,				    "%s Proc data for %s must be MATLAB int16\n Last errors are are:\n%s",				    errBadData,name,FrErrorGetHistory() ); 		}	      proc = FrProcDataNew(frame, name, rate, numData, 16);	      if(proc == NULL)		{		  mexErrMsgIdAndTxt(errFrameFail,				    "%s Proc for %s is null\n Last errors are:\n%s",				    errFrameFail,name,FrErrorGetHistory() );		}	      memcpy(proc->data->dataS,dataPtr,dataBytes);	    }	  else if(type[0] == 'i')	    {	      if(!mxIsInt32(dataVector))		{		  mexErrMsgIdAndTxt(errBadData,				    "%s Proc data for %s must be MATLAB int32\n Last errors are are:\n%s",				    errBadData,name,FrErrorGetHistory() ); 		}	      proc = FrProcDataNew(frame, name, rate, numData, 32);	      if(proc == NULL)		{		  mexErrMsgIdAndTxt(errFrameFail,				    "%s Proc for %s is null\n Last errors are:\n%s",				    errFrameFail,name,FrErrorGetHistory() );		}	      memcpy(proc->data->dataI,dataPtr,dataBytes);	    }	  else if(type[0] == 'l')	    {	      if(!mxIsInt64(dataVector))		{		  mexErrMsgIdAndTxt(errBadData,				    "%s Proc data for %s must be MATLAB int64\n Last errors are are:\n%s",				    errBadData,name,FrErrorGetHistory() ); 		}	      proc = FrProcDataNew(frame, name, rate, numData, 64);	      if(proc == NULL)		{		  mexErrMsgIdAndTxt(errFrameFail,				    "%s Proc for %s is null\n Last errors are:\n%s",				    errFrameFail,name,FrErrorGetHistory() );		}	      memcpy(proc->data->dataL,dataPtr,dataBytes);	    }	  else if(type[0] == 'u')	    {	      if(type[1] == 's')		{		  if(!mxIsUint16(dataVector))		    {		      mexErrMsgIdAndTxt(errBadData,					"%s Proc data for %s must be MATLAB uint16\n Last errors are are:\n%s",					errBadData,name,FrErrorGetHistory() ); 		    }		  proc = FrProcDataNew(frame, name, rate, numData, 16);		  if(proc == NULL)		    {		      mexErrMsgIdAndTxt(errFrameFail,					"%s Proc for %s is null\n Last errors are:\n%s",					errFrameFail,name,FrErrorGetHistory() );		    }		  memcpy(proc->data->dataUS,dataPtr,dataBytes);		}	      else if(type[1] == 'i')		{		  if(!mxIsUint32(dataVector))		    {		      mexErrMsgIdAndTxt(errBadData,					"%s Proc data for %s must be MATLAB uint32\n Last errors are are:\n%s",					errBadData,name,FrErrorGetHistory() ); 		    }		  proc = FrProcDataNew(frame, name, rate, numData, 32);		  if(proc == NULL)		    {		      mexErrMsgIdAndTxt(errFrameFail,					"%s Proc for %s is null\n Last errors are:\n%s",					errFrameFail,name,FrErrorGetHistory() );		    }		  memcpy(proc->data->dataUI,dataPtr,dataBytes);		}	      else if(type[1] == 'l')		{		  if(!mxIsUint64(dataVector))		    {		      mexErrMsgIdAndTxt(errBadData,					"%s Proc data for %s must be MATLAB uint64\n Last errors are are:\n%s",					errBadData,name,FrErrorGetHistory() ); 		    }		  proc = FrProcDataNew(frame, name, rate, numData, 64);		  if(proc == NULL)		    {		      mexErrMsgIdAndTxt(errFrameFail,					"%s Proc for %s is null\n Last errors are:\n%s",					errFrameFail,name,FrErrorGetHistory() );		    }		  memcpy(proc->data->dataUL,dataPtr,dataBytes);		}	    }	}    }    if( nrhs > 5 )    {      if( mxIsEmpty(prhs[5]) )	{ 	  mexPrintf("Input Comment: No parameters array will be written to frame \n");	}      else if(!mxIsStruct(prhs[5]))	{	  mexErrMsgIdAndTxt(errBadInput,"%s The parameters input must be a structure",errBadInput);	}      else	{	  paramElems = mxGetNumberOfElements(prhs[5]);	  if(paramElems < 1)	    {	      mexErrMsgIdAndTxt(errBadField,"%s no elements in parameters structure array",errBadField);	    }	  	  pChannelName = mxGetField(prhs[5], 0, "name");	  pChannelStr = mxArrayToString(pChannelName);	  	  for(elem=0; elem < paramElems; elem++)	    {	      Parameters = mxGetField(prhs[5], elem, "parameters");	    }	  paramCols = mxGetN(Parameters);	  	  if( mxGetNumberOfDimensions(Parameters) > 2 ) 	    {	      mexErrMsgIdAndTxt(errBadField,"%s params must be a two dimensional array or a vector",errBadField);	    }	  else 	    {	      numParams = mxGetNumberOfElements(Parameters);	      paramColsD = paramCols; /*changing integer to double*/	      	      paramV = FrVectNew(FR_VECT_STRING, 1, numParams, paramColsD, "units");	      if( paramV == NULL) 		{		  mexErrMsgIdAndTxt(errBadData,"%s Vector for %s is null\n Last errors are:\n%s",				    errFrameFail,pChannelStr,FrErrorGetHistory() );		}	      	      pComment = mxCalloc(commentBuf, sizeof(char));	      pComment = "paramV is a vector made of N column vectors, with N = paramV->dx[0] "; 			      	      for(i=0; i < numParams; i++)		{			  		  paramCell = mxGetCell(Parameters, i);		  cetStr = mxArrayToString(paramCell);		  FrStrCpy(&(paramV->dataQ[i]), cetStr);		}	      	      StatParams = FrStatDataNew(pChannelStr, pComment, NULL, t0, t0+1, 0, paramV, NULL);	      FrStatDataAdd(frame->detectProc, StatParams);	    }	}    }  	     if( nrhs > 6 )    {      if( mxIsEmpty(prhs[6]) )	{ 	  comment = NULL;	  mexPrintf("Input Comment: No comment will be added to frame \n");	}        else	{	  if(!mxIsChar(prhs[6]))	    {	      mexErrMsgIdAndTxt(errBadInput,"%s The comment must be a string",errBadInput);	    }	  comment = mxCalloc(commentBuf, sizeof(char));	  mxGetString(prhs[6], comment, commentBuf);  /* written to frame using FrFileOSetMsg */	  mexPrintf("MKFRAME: Add to frame the comment: %s \n",comment);	}    }  else    {      comment = NULL;    }	    /*-----------write frame to the output file-----------------------*/    oFile = FrFileONew(fileName, compress);    if(oFile == NULL)    {      mexErrMsgIdAndTxt(errFrameFail,"%s Error during output file creation.\n"			"Last errors are:\n%s", errFrameFail,FrErrorGetHistory() );    }    if(comment != NULL)    {      FrFileOSetMsg(oFile, comment);    }    if(mode[0] == 'a')    {      mexPrintf("MKFRAME: Write out updated frame file %s\n",fileName);    }  else    {      mexPrintf("MKFRAME: Write out new frame file %s\n",fileName);    }  if(FrameWrite(frame, oFile) != FR_OK)    {      mexErrMsgIdAndTxt(errFrameFail,"%s Error during frame write.\n"			"Last errors are:\n%s", errFrameFail,FrErrorGetHistory() );    }  /*-----------close down------------------------*/  FrFileOEnd(oFile);  FrameFree(frame);     mexPrintf("MKFRAME: Complete frame file writing\n");  }